<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variant C - Progressive Disclosure Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Smooth fade-in for the error modal */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
        /* Style for locked content */
        .locked-content {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Icon for the completed state
        const Check = ({ size = 16, className = "text-white" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        );
        
        // Icon for the locked state
        const Lock = ({ size = 20, className = "text-gray-400" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        // Icon for the download button in the final state
        const Download = ({ size = 20 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const STEPS_META = {
            1: { name: 'Personal Information', fields: ['fullName', 'dateOfBirth', 'email', 'phone'] },
            2: { name: 'Address Information', fields: ['streetAddress', 'city', 'postcode', 'country'] },
            3: { name: 'Employment/Study Status', fields: ['employmentStatus'] }, // Conditional fields handled separately
            4: { name: 'Core Education', fields: ['highestQualification', 'institutionName', 'yearCompletion'] },
            5: { name: 'Job Preferences', fields: ['desiredPosition', 'startDate', 'salaryExpectations', 'coverLetter'] },
        };

        const TOTAL_STEPS = 5; 

        // Define all possible fields, noting which step they belong to and their conditional visibility
        const ALL_FIELDS = [
            // STEP 1: Personal Information (Required for Step 2)
            { name: 'fullName', label: 'Full Name', required: true, type: 'text', step: 1 },
            { name: 'dateOfBirth', label: 'Date of Birth', required: true, type: 'date-composite', step: 1 },
            { name: 'email', label: 'Email', required: true, type: 'email', step: 1 },
            { name: 'phone', label: 'Phone Number', required: true, type: 'tel', step: 1 },
            
            // STEP 2: Address Information (Required for Step 3)
            { name: 'streetAddress', label: 'Street Address', required: true, type: 'text', colSpan: 2, step: 2 },
            { name: 'city', label: 'City', required: true, type: 'text', step: 2 },
            { name: 'postcode', label: 'Postcode', required: true, type: 'text', step: 2 },
            { name: 'country', label: 'Country', required: true, type: 'text', colSpan: 2, step: 2 },

            // STEP 3: Employment/Study Status (Conditional Logic here, Required for Step 4)
            { name: 'employmentStatus', label: 'Current Status', required: true, type: 'select', options: ['Select...', 'Employed', 'Unemployed', 'Student'], colSpan: 2, step: 3 },
            
            // Conditional Fields for Employed
            { name: 'currentEmployer', label: 'Current Employer', required: true, type: 'text', step: 3, conditional: 'Employed' },
            { name: 'jobTitle', label: 'Job Title', required: true, type: 'text', step: 3, conditional: 'Employed' },
            { name: 'yearsExperience', label: 'Years of Experience', required: false, type: 'number', step: 3, conditional: 'Employed' },

            // Conditional Fields for Student
            { name: 'studentInstitution', label: 'Institution Name', required: true, type: 'text', step: 3, conditional: 'Student' },
            { name: 'expectedGraduation', label: 'Expected Graduation Date', required: true, type: 'date', step: 3, conditional: 'Student' },

            // Conditional Fields for Unemployed
            { name: 'lastEmployer', label: 'Last Employer', required: true, type: 'text', step: 3, conditional: 'Unemployed' },
            { name: 'dateLeft', label: 'Date Left', required: true, type: 'date', step: 3, conditional: 'Unemployed' },

            // STEP 4: Core Education (Required for Step 5)
            { name: 'highestQualification', label: 'Highest Completed Qualification', required: true, type: 'text', step: 4 },
            { name: 'institutionName', label: 'Institution Name', required: true, type: 'text', step: 4 },
            { name: 'yearCompletion', label: 'Year of Completion', required: true, type: 'year-select', step: 4 },
            
            // STEP 5: Job Preferences (Required for Submission)
            { name: 'desiredPosition', label: 'Desired Position', required: true, type: 'select', step: 5 },
            { name: 'startDate', label: 'Earliest Start Date', required: true, type: 'date', step: 5 },
            { name: 'salaryExpectations', label: 'Salary Expectations ($USD)', required: false, type: 'text', step: 5 },
            { name: 'coverLetter', label: 'Cover Letter (Optional)', required: false, type: 'textarea', colSpan: 2, step: 5 }
        ];

        function MultiStepForm() {
            const [step, setStep] = useState(1);
            const [formData, setFormData] = useState({
                employmentStatus: ''
            });
            const [errors, setErrors] = useState({});
            const [logs, setLogs] = useState([]);
            const [firstInteraction, setFirstInteraction] = useState(null);
            const [submitted, setSubmitted] = useState(false);
            const participantId = useRef(`P${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`);
            const errorModalRef = useRef(null);

            // --- Logging and Setup ---

            useEffect(() => {
                const startTime = performance.now();
                addLog('formLoad', { timestamp: startTime });
            }, []);
            
            useEffect(() => {
                addLog('stepViewed', { step, stepName: STEPS_META[step].name });
            }, [step]);


            const addLog = (eventType, data = {}) => {
                setLogs(prev => [...prev, {
                    participantID: participantId.current,
                    variant: 'C',
                    timestamp: performance.now(),
                    event: eventType,
                    step: step, 
                    ...data
                }]);
            };

            // --- Validation Functions ---
            
            const validateField = useCallback((name, value, required, type) => {
                let error = '';
                
                if (required) {
                    if (!value || (typeof value === 'string' && !value.trim())) {
                        error = `${ALL_FIELDS.find(f => f.name === name)?.label || name} is required`;
                        return error;
                    }
                }

                if (!value) return ''; // If value is empty and not required, no error

                switch(type) {
                    case 'email': 
                        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) error = 'Invalid email format'; 
                        break;
                    case 'number': 
                        const val = parseInt(value);
                        if (value && isNaN(val)) error = 'Must be a number';
                        if (name === 'yearCompletion') {
                            const currentYear = new Date().getFullYear();
                            if (val > currentYear + 5 || val < 1900) error = `Invalid year (must be between 1900 and ${currentYear + 5})`;
                        }
                        if (name === 'yearsExperience' && val < 0) error = 'Cannot be negative';
                        break;
                }
                return error;
            }, []);

            const getRequiredFieldsForStep = (currentStep) => {
                let fields = ALL_FIELDS.filter(f => f.step === currentStep);
                
                if (currentStep === 3) {
                    // Filter conditional fields based on employmentStatus
                    const status = formData.employmentStatus;
                    
                    if (status) {
                        fields = fields.filter(f => !f.conditional || f.conditional.toLowerCase() === status);
                    } else {
                        // If no status is selected, only the status dropdown is relevant
                        fields = fields.filter(f => !f.conditional);
                    }
                }
                
                // Return only required fields from the visible set
                return fields.filter(f => f.required);
            };

            const validateStep = useCallback((currentStep) => {
                const requiredFields = getRequiredFieldsForStep(currentStep);
                const newErrors = {};
                let validationErrorCount = 0;
                
                requiredFields.forEach(field => {
                    let value = formData[field.name];
                    
                    if (field.type === 'date-composite') {
                        // Special check for dateOfBirth composite field (Step 1)
                        const year = formData.dobYear;
                        const month = formData.dobMonth;
                        const day = formData.dobDay;
                        
                        if (!year || !month || !day) {
                            newErrors['dateOfBirth'] = 'Please complete your full date of birth.';
                            addLog('validationError', { fieldName: 'dateOfBirth', errorType: 'missing_required', errorMessage: 'Incomplete Date of Birth' });
                            validationErrorCount++;
                        }
                    } else {
                        // Validate all other required fields
                        const error = validateField(field.name, value, field.required, field.type);
                        if (error) {
                            newErrors[field.name] = error;
                            addLog('validationError', { fieldName: field.name, errorType: 'missing_required', errorMessage: error });
                            validationErrorCount++;
                        }
                    }
                });

                // Clear errors for fields NOT in the current step and merge new errors
                setErrors(prevErrors => {
                    const currentStepFieldNames = ALL_FIELDS.filter(f => f.step === currentStep).map(f => f.name);
                    const filteredErrors = Object.keys(prevErrors).filter(name => !currentStepFieldNames.includes(name)).reduce((acc, name) => {
                        acc[name] = prevErrors[name];
                        return acc;
                    }, {});
                    return { ...filteredErrors, ...newErrors };
                });

                return validationErrorCount === 0;
            }, [formData, addLog, validateField]);

            const isStepComplete = (stepNumber) => {
                // Check if all required fields for that step (if they were visible) are filled out and valid.
                // NOTE: This check is purely based on whether fields have a value and no stored error.
                // For a true progressive disclosure model, we only need to check the last successfully navigated step.
                
                if (stepNumber < 1 || stepNumber > TOTAL_STEPS) return false;

                // Simple check: The user has successfully passed this step
                return stepNumber < step;
            };

            // --- Handlers ---

            const handleFocus = (fieldName) => {
                if (!firstInteraction) {
                    setFirstInteraction(performance.now());
                    addLog('firstInteraction', { fieldName });
                }
                addLog('fieldFocus', { fieldName });
            };

            const handleBlur = (fieldName, value, type) => {
                addLog('fieldBlur', { fieldName });
                const field = ALL_FIELDS.find(f => f.name === fieldName);
                if (field && field.type !== 'date-composite') {
                    const error = validateField(fieldName, value, field.required, type);
                    setErrors(prev => {
                        const newErrors = { ...prev };
                        if (error) {
                            newErrors[fieldName] = error;
                            addLog('validationError', { fieldName, errorType: 'invalid_input', errorMessage: error });
                        } else {
                            delete newErrors[fieldName];
                        }
                        return newErrors;
                    });
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                
                setFormData(prev => {
                    const newState = { ...prev, [name]: value };
                    
                    // Logic to compile dateOfBirth from dobYear, dobMonth, dobDay selects
                    if (name.startsWith('dob')) {
                        const year = newState.dobYear || prev.dobYear;
                        const month = newState.dobMonth || prev.dobMonth;
                        const day = newState.dobDay || prev.dobDay;
                        
                        if (year && month && day) {
                            newState.dateOfBirth = `${year}-${month}-${day}`; 
                            // Auto-clear error if date is complete
                            setErrors(prevErrors => {
                                const { dateOfBirth, ...rest } = prevErrors;
                                return rest;
                            });
                        } else {
                            newState.dateOfBirth = '';
                        }
                    }

                    // Conditional Logic: Clear dependent fields if status changes
                    if (name === 'employmentStatus') {
                        const clearedFields = {
                            currentEmployer: '', jobTitle: '', yearsExperience: '',
                            studentInstitution: '', expectedGraduation: '',
                            lastEmployer: '', dateLeft: ''
                        };
                        return { ...newState, ...clearedFields };
                    }
                    
                    return newState;
                });
                addLog('fieldInput', { fieldName: name });
            };

            const handleNavigation = (action) => {
                addLog('navigationAttempt', { action });
                
                if (action === 'back') {
                    setStep(prev => prev - 1);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return;
                }
                
                // For 'next' or 'submit'
                if (validateStep(step)) {
                    addLog('navigationSuccess', { action });
                    if (step < TOTAL_STEPS) {
                        setStep(prev => prev + 1);
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } else if (step === TOTAL_STEPS && action === 'submit') {
                        const endTime = performance.now();
                        addLog('formSubmit', { timestamp: endTime, completionTime: ((endTime - (firstInteraction || endTime)) / 1000).toFixed(2) });
                        setSubmitted(true);
                    }
                } else {
                    addLog('navigationBlock', { action, reason: 'validation_errors', errorCount: Object.keys(errors).length });
                    // Show error modal
                    if (errorModalRef.current) {
                        errorModalRef.current.style.display = 'flex';
                        setTimeout(() => {
                             errorModalRef.current.style.display = 'none';
                        }, 3000);
                    }
                }
            };

            const downloadLogs = () => {
                if (logs.length === 0) return;
                
                const headers = Object.keys(logs[0] || {}).join(',');
                const rows = logs.map(row => Object.values(row).map(val => {
                    let stringVal = String(val);
                    if (stringVal.includes(',') || stringVal.includes('"') || stringVal.includes('\n')) {
                        return `"${stringVal.replace(/"/g, '""')}"`;
                    }
                    return stringVal;
                }).join(','));
                
                const csv = [headers, ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${participantId.current}_VariantC_logs.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            
            // Utility to render the input fields 
            const renderField = (fieldConfig) => {
                const { name, label, type, required, colSpan = 1, options = [] } = fieldConfig;
                const hasError = errors[name];
                const colClass = colSpan === 2 ? 'md:col-span-2' : '';
                const baseClass = `w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`;

                if (type === 'textarea') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <textarea
                                name={name}
                                value={formData[name] || ''}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                rows="4"
                                className={baseClass}
                                placeholder={`Enter your ${label.toLowerCase()} here...`}
                            />
                            {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                        </div>
                    );
                }

                if (type === 'select') {

                    const options = name === 'employmentStatus' ? 
                        ['Select...', 'Employed', 'Unemployed', 'Student', 'Self-Employed'] : [];
                        if (name === 'desiredPosition') {
                        options.push('Select...', 'Software Engineer', 'Product Manager', 'Designer', 'Data Analyst', 'Other');
                    } else if (options.length === 0) {
                        options.push('Select...');
                    }  
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <select
                                name={name}
                                value={formData[name] || ''}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                onBlur={(e) => handleBlur(name, e.target.value, type)}
                                className={baseClass}
                            >
                                {options.map(opt => <option key={opt} value={opt === 'Select...' ? '' : opt.toLowerCase()}>{opt}</option>)}
                            </select>
                            {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                        </div>
                    );
                }

                if (type === 'year-select') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <select
                                name={name}
                                value={formData[name]}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                onBlur={(e) => handleBlur(name, e.target.value)}
                                className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                            >
                                <option value="">Select Year</option>
                                {Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                            {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                        </div>
                    );
                }
                
                if (type === 'date-composite') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <div className="grid grid-cols-3 gap-2">
                                <select 
                                    name="dobYear" 
                                    value={formData.dobYear || ''} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobYear')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Year</option>
                                    {Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i).map(year => <option key={year} value={year}>{year}</option>)}
                                </select>
                                <select 
                                    name="dobMonth" 
                                    value={formData.dobMonth || ''} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobMonth')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Month</option>
                                    {Array.from({ length: 12 }, (_, i) => String(i + 1).padStart(2, '0')).map(month => <option key={month} value={month}>{new Date(0, month-1).toLocaleString('default', { month: 'short' })}</option>)}
                                </select>
                                <select 
                                    name="dobDay" 
                                    value={formData.dobDay || ''} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobDay')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Day</option>
                                    {Array.from({ length: 31 }, (_, i) => String(i + 1).padStart(2, '0')).map(day => <option key={day} value={day}>{day}</option>)}
                                </select>
                            </div>
                            {errors.dateOfBirth && <p className="text-red-500 text-xs mt-1">{errors.dateOfBirth}</p>}
                        </div>
                    );
                }

                // Default text/number/email/date input
                return (
                    <div key={name} className={colClass}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                        <input
                            type={type}
                            name={name}
                            value={formData[name] || ''}
                            onChange={handleChange}
                            onFocus={() => handleFocus(name)}
                            onBlur={(e) => handleBlur(name, e.target.value, type)}
                            className={baseClass}
                            required={required}
                        />
                        {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                    </div>
                );
            };

            const renderCurrentStepFields = () => {
                const status = formData.employmentStatus;

                // 1. Get base fields for the current step
                let fieldsInCurrentStep = ALL_FIELDS.filter(f => f.step === step);
                
                // 2. Handle conditional rendering for Step 3
                if (step === 3) {
                    const baseFields = fieldsInCurrentStep.filter(f => !f.conditional); // employmentStatus dropdown
                    const conditionalFields = fieldsInCurrentStep.filter(f => f.conditional && f.conditional.toLowerCase() === status);
                    fieldsInCurrentStep = [...baseFields, ...conditionalFields];
                }

                return (
                    <div className="mb-8 p-6 rounded-xl bg-gray-50/70 shadow-inner">
                        <h3 className="text-xl font-bold text-indigo-700 mb-6 pb-2 border-b-2 border-indigo-300">{STEPS_META[step].name}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {fieldsInCurrentStep.map(renderField)}
                        </div>
                    </div>
                );
            };

            // Checks if a step (stepNumber) is currently locked
            const isStepLocked = (stepNumber) => {
                if (stepNumber === 1) return false;
                // A step is locked if the previous step has not been successfully passed (i.e., stepNumber > current step)
                return stepNumber > step;
            }

            const renderStepContent = (stepNumber) => {
                const locked = isStepLocked(stepNumber);
                
                if (stepNumber === step) {
                    return renderCurrentStepFields();
                }

                if (locked) {
                    return (
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-gray-300 relative min-h-[150px] flex items-center justify-center">
                            <div className="absolute inset-0 bg-gray-50 opacity-90 rounded-xl z-10 flex flex-col items-center justify-center text-gray-500">
                                <Lock size={32} className="text-gray-400 mb-2"/>
                                <p className="text-lg font-semibold">Step {stepNumber} is locked.</p>
                                <p className="text-sm">Complete all required fields in Step {stepNumber - 1} to unlock.</p>
                            </div>
                            {/* Render hidden fields for layout consistency, but blur them */}
                            <div className="locked-content grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                                {ALL_FIELDS.filter(f => f.step === stepNumber).map(field => (
                                    <div key={field.name} className={field.colSpan === 2 ? 'md:col-span-2' : ''}>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">{field.label} {field.required && '*'}</label>
                                        <input className="w-full px-3 py-2 border rounded-md border-gray-300 bg-gray-100" disabled />
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }

                // If step is completed
                return (
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border-l-4 border-indigo-500">
                        <h3 className="text-xl font-bold text-indigo-700 flex items-center mb-2">
                            <Check size={18} className="text-indigo-600 mr-2 border-2 border-indigo-600 rounded-full p-0.5" />
                            {STEPS_META[stepNumber].name} - Complete
                        </h3>
                        <p className="text-sm text-gray-500">You may navigate back to this step using the 'Back' button if needed.</p>
                    </div>
                );
            };

            // Progress bar with lock icons
            const renderProgressBar = () => (
                <div className="mb-8 p-4 bg-white rounded-xl shadow-lg">
                    <nav aria-label="Progress" className="w-full">
                        <ol role="list" className="flex items-center justify-between">
                            {[...Array(TOTAL_STEPS)].map((_, index) => {
                                const stepNumber = index + 1;
                                const isCurrent = stepNumber === step;
                                const isLocked = isStepLocked(stepNumber);
                                const isCompleted = stepNumber < step;
                                
                                let circleClasses = 'w-10 h-10 flex items-center justify-center rounded-full font-bold text-sm transition duration-300 ease-in-out z-10';
                                let lineClasses = 'flex-1 h-1 transition duration-300 ease-in-out';
                                
                                if (isCompleted) {
                                    circleClasses += ' bg-indigo-600 text-white';
                                    lineClasses += ' bg-indigo-600';
                                } else if (isCurrent) {
                                    circleClasses += ' bg-indigo-500 text-white shadow-lg ring-4 ring-indigo-200';
                                    lineClasses += ' bg-gray-300';
                                } else if (isLocked) {
                                    circleClasses += ' bg-gray-100 border-2 border-gray-300 text-gray-500';
                                    lineClasses += ' bg-gray-300';
                                } else { // Step is unlocked but not current (only possible if user is on Step 1)
                                    circleClasses += ' bg-white border-2 border-gray-300 text-gray-500';
                                    lineClasses += ' bg-gray-300';
                                }

                                return (
                                    <React.Fragment key={stepNumber}>
                                        <li className="flex items-center">
                                            <div className={circleClasses}>
                                                {isCompleted ? <Check size={16} /> : (isLocked ? <Lock size={18} className="text-gray-500" /> : stepNumber)}
                                            </div>
                                        </li>
                                        {stepNumber < TOTAL_STEPS && (
                                            <div className={lineClasses}></div>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </ol>
                    </nav>
                     <div className="text-center text-indigo-700 font-semibold mt-4">
                        Step {step} of {TOTAL_STEPS}: {STEPS_META[step].name}
                    </div>
                </div>
            );

                const handleSubmit = (e) => {
                e.preventDefault();
                addLog('navigationAttempt', { action: 'submit' });
                
                if (validateForm()) {
                    const endTime = performance.now();
                    const completionTime = ((endTime - (firstInteraction || endTime)) / 1000).toFixed(2);
                    const totalErrors = logs.filter(l => l.event === 'validationError').length;
                    
                    addLog('formSubmit', { timestamp: endTime, completionTime });
                    
                    // ave completion status to localStorage
                    const storedData = JSON.parse(localStorage.getItem('formStudyData') || '{}');
                    localStorage.setItem('formStudyData', JSON.stringify({
                        ...storedData,
                        status: {
                            ...storedData.status,
                            'A': { status: 'complete', errors: totalErrors, time: completionTime }
                        }
                    }));
                    
                    // Check if NASA-TLX already completed for Variant A
                    const tlxData = JSON.parse(localStorage.getItem('nasa_tlx_A') || '{}');
                    const tlxCompleted = tlxData[participantId.current] !== undefined;
                    
                    if (tlxCompleted) {
                        // NASA-TLX already done, go to index
                        window.location.href = 'index.html';
                    } else {
                        // Redirect to NASA-TLX
                        window.location.href = `NASATLX.html?variant=A&participant=${participantId.current}`;
                    }
                } else {
                    addLog('navigationBlock', { action: 'submit', reason: 'validation_errors', errorCount: Object.keys(errors).length });
                    if (errorModalRef.current) {
                        errorModalRef.current.style.display = 'flex';
                        setTimeout(() => {
                             errorModalRef.current.style.display = 'none';
                        }, 3000);
                    }
                }
            };

            // --- Rendered Output ---
            
            if (submitted) {
                const completionTimeSeconds = ((performance.now() - (firstInteraction || performance.now())) / 1000).toFixed(2);
                const totalErrors = logs.filter(l => l.event === 'validationError').length;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-8 flex items-center justify-center">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-indigo-600">
                            <div className="text-indigo-600 text-7xl mb-4">
                                <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h2 className="text-3xl font-extrabold text-gray-900 mb-4">Application Submitted!</h2>
                            <p className="text-gray-600 mb-6">Thank you for completing the progressive disclosure application form.</p>
                            <button onClick={downloadLogs} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2 mx-auto shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                                <Download size={20} />
                                Download Session Logs
                            </button>
                            <div className="mt-8 text-sm text-gray-500 bg-gray-50 p-4 rounded-lg">
                                <p>Total Events Logged: <span className="font-medium text-gray-700">{logs.length}</span></p>
                                <p>Time to Complete (from first interaction): <span className="font-medium text-gray-700">{completionTimeSeconds}s</span></p>
                                <p>Total Validation Errors Triggered: <span className="font-medium text-gray-700">{totalErrors}</span></p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4 sm:p-8 font-sans">
                    {/* Floating Error Modal */}
                    <div ref={errorModalRef} style={{ display: 'none' }} className="fixed top-4 right-4 z-50 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-xl animate-fade-in-down transition duration-500 ease-in-out hidden items-center space-x-2" role="alert">
                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd"></path></svg>
                        <p className="font-medium text-sm">Please correct the highlighted error(s) to continue.</p>
                    </div>

                    <form onSubmit={(e) => e.preventDefault()} className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
                        <div className="mb-8">
                            <h1 className="text-3xl font-extrabold text-gray-900 mb-2">Job Application Form</h1>
                            <p className="text-gray-600">Variant C: Progressive Disclosure & Conditional Logic</p>
                            <p className="text-sm text-gray-500 mt-1">Participant ID: {participantId.current}</p>
                        </div>
                        
                        {renderProgressBar()}

                        {/* Step Content: Show only the current step in detail */}
                        <div className="space-y-6">
                            {[...Array(TOTAL_STEPS)].map((_, index) => {
                                const stepNumber = index + 1;
                                return (
                                    <div key={stepNumber} style={{ display: stepNumber === step ? 'block' : 'none' }}>
                                        {renderStepContent(stepNumber)}
                                    </div>
                                );
                            })}
                        </div>
                        
                        {/* Navigation Buttons */}
                        <div className="flex justify-between pt-8 border-t mt-8">
                            <button
                                type="button"
                                onClick={() => handleNavigation('back')}
                                disabled={step === 1}
                                className={`px-6 py-3 rounded-lg font-semibold transition ${step === 1 ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-white text-indigo-600 border border-indigo-600 hover:bg-indigo-50 shadow-md'}`}
                            >
                                Back
                            </button>
                            
                            {step < TOTAL_STEPS && (
                                <button 
                                    type="button"
                                    onClick={() => handleNavigation('next')}
                                    className="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md"
                                >
                                    Next Step
                                </button>
                            )}

                            {step === TOTAL_STEPS && (
                                <button 
                                    type="button"
                                    onClick={() => handleNavigation('submit')}
                                    className="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-md"
                                >
                                    Submit Application
                                </button>
                            )}
                        </div>
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MultiStepForm />);
    </script>
</body>
</html>