<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variant A - Single-Page Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Smooth fade-in for the error modal */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icon for the completed state
        const Download = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        // Define all fields and their requirement status for consolidated validation
        const ALL_FIELDS = [
            { name: 'fullName', label: 'Full Name', required: true, type: 'text', group: 'Personal Information' },
            { name: 'dateOfBirth', label: 'Date of Birth', required: true, type: 'date-composite', group: 'Personal Information' }, // Composite field
            { name: 'email', label: 'Email', required: true, type: 'email', group: 'Personal Information' },
            { name: 'phone', label: 'Phone Number', required: true, type: 'tel', group: 'Personal Information' },
            
            { name: 'streetAddress', label: 'Street Address', required: true, type: 'text', group: 'Address Information', colSpan: 2 },
            { name: 'city', label: 'City', required: true, type: 'text', group: 'Address Information' },
            { name: 'postcode', label: 'Postcode', required: true, type: 'text', group: 'Address Information' },
            { name: 'country', label: 'Country', required: true, type: 'text', group: 'Address Information', colSpan: 2 },

            { name: 'employmentStatus', label: 'Employment Status', required: true, type: 'select', group: 'Employment History' },
            { name: 'employer', label: 'Current/Most Recent Employer', required: false, type: 'text', group: 'Employment History' },
            { name: 'jobTitle', label: 'Job Title', required: false, type: 'text', group: 'Employment History' },
            { name: 'yearsExperience', label: 'Years of Experience', required: false, type: 'number', group: 'Employment History' },
            

            { name: 'qualification', label: 'Highest Qualification', required: true, type: 'text', group: 'Education' },
            { name: 'institution', label: 'Institution', required: true, type: 'text', group: 'Education' },
            { name: 'yearCompletion', label: 'Year of Completion', required: true, type: 'year-select', group: 'Education' },
            
            
            { name: 'desiredPosition', label: 'Desired Position', required: true, type: 'select', group: 'Job Preferences' },
            { name: 'startDate', label: 'Earliest Start Date', required: true, type: 'date', group: 'Job Preferences' },
            { name: 'salaryExpectations', label: 'Salary Expectations', required: false, type: 'text', group: 'Job Preferences' },
            { name: 'coverLetter', label: 'Cover Letter', required: false, type: 'textarea', group: 'Job Preferences', colSpan: 2 }
        ];

        function SinglePageForm() {
            const [formData, setFormData] = useState({
                fullName: '', dateOfBirth: '', dobYear: '', dobMonth: '', dobDay: '', email: '', phone: '',
                streetAddress: '', city: '', postcode: '', country: '', employmentStatus: '', employer: '', jobTitle: '',
                yearsExperience: '', qualification: '', institution: '',
                yearCompletion: '', desiredPosition: '', startDate: '', salaryExpectations: '', coverLetter: ''
            });

            const [errors, setErrors] = useState({});
            const [logs, setLogs] = useState([]);
            const [firstInteraction, setFirstInteraction] = useState(null);
            const [submitted, setSubmitted] = useState(false);
            
            // Get or create participant ID from localStorage
            const getParticipantId = () => {
                const storedData = JSON.parse(localStorage.getItem('formStudyData') || '{}');
                if (storedData.participantId) {
                    return storedData.participantId;
                }
                const newId = `P${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;
                localStorage.setItem('formStudyData', JSON.stringify({ ...storedData, participantId: newId }));
                return newId;
            };
            
            const participantId = useRef(getParticipantId());
            const errorModalRef = useRef(null);

            // --- Logging and Setup ---

            useEffect(() => {
                const startTime = performance.now();
                addLog('formLoad', { timestamp: startTime });
            }, []);

            const addLog = (eventType, data = {}) => {
                setLogs(prev => [...prev, {
                    participantID: participantId.current,
                    variant: 'A',
                    timestamp: performance.now(),
                    event: eventType,
                    step: 1, 
                    ...data
                }]);
            };

            // Save logs to localStorage whenever they change
            useEffect(() => {
                if (logs.length > 0) {
                    const logKey = 'logs_A';
                    const allLogs = JSON.parse(localStorage.getItem(logKey) || '{}');
                    allLogs[participantId.current] = logs;
                    localStorage.setItem(logKey, JSON.stringify(allLogs));
                }
            }, [logs]);

            // --- Validation Functions ---

            const validateField = (name, value, required) => {
                let error = '';
                
                if (required) {
                    if (!value || (typeof value === 'string' && !value.trim())) {
                        error = `${ALL_FIELDS.find(f => f.name === name)?.label || name} is required`;
                        return error;
                    }
                }

                if (!value) return ''; // If value is empty and not required, no error

                switch(name) {
                    case 'email': 
                        if (value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) error = 'Invalid email format'; 
                        break;
                    case 'yearCompletion': 
                        if (value && (isNaN(parseInt(value)) || parseInt(value) > new Date().getFullYear())) error = 'Invalid year';
                        break;
                }
                return error;
            };

            const validateForm = () => {
                const newErrors = {};
                
                // 1. Validate simple required fields
                ALL_FIELDS
                    .filter(f => f.required && f.type !== 'date-composite')
                    .forEach(field => {
                        const error = validateField(field.name, formData[field.name], true);
                        if (error) {
                            newErrors[field.name] = error;
                            addLog('validationError', { fieldName: field.name, errorType: 'missing_required', errorMessage: error });
                        }
                    });

                // 2. Validate composite date field (dateOfBirth)
                const dateField = ALL_FIELDS.find(f => f.name === 'dateOfBirth');
                if (dateField && dateField.required) {
                    const year = formData.dobYear;
                    const month = formData.dobMonth;
                    const day = formData.dobDay;
                    
                    if (!year || !month || !day) {
                        newErrors['dateOfBirth'] = 'Please complete your full date of birth.';
                        addLog('validationError', { fieldName: 'dateOfBirth', errorType: 'missing_required', errorMessage: 'Incomplete Date of Birth' });
                    }
                }

                // 3. Validate non-required fields with format checks (e.g., email format)
                ['email', 'yearCompletion'].forEach(name => {
                    if (!newErrors[name]) {
                        const field = ALL_FIELDS.find(f => f.name === name);
                        const error = validateField(field.name, formData[field.name], field.required);
                        if (error) {
                            newErrors[field.name] = error;
                            addLog('validationError', { fieldName: field.name, errorType: 'invalid_input', errorMessage: error });
                        }
                    }
                });

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            // --- Handlers ---

            const handleFocus = (fieldName) => {
                if (!firstInteraction) {
                    setFirstInteraction(performance.now());
                    addLog('firstInteraction', { fieldName });
                }
                addLog('fieldFocus', { fieldName });
            };

            const handleBlur = (fieldName, value) => {
                addLog('fieldBlur', { fieldName });
                const field = ALL_FIELDS.find(f => f.name === fieldName);
                if (field && field.type !== 'date-composite') {
                    const error = validateField(fieldName, value, field.required);
                    setErrors(prev => {
                        const newErrors = { ...prev };
                        if (error) {
                            newErrors[fieldName] = error;
                            addLog('validationError', { fieldName, errorType: 'invalid_input', errorMessage: error });
                        } else {
                            delete newErrors[fieldName];
                        }
                        return newErrors;
                    });
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => {
                    const newState = { ...prev, [name]: value };
                    
                    if (name.startsWith('dob')) {
                        const year = newState.dobYear || prev.dobYear;
                        const month = newState.dobMonth || prev.dobMonth;
                        const day = newState.dobDay || prev.dobDay;
                        
                        if (year && month && day) {
                            newState.dateOfBirth = `${year}-${month}-${day}`;
                            setErrors(prevErrors => {
                                const { dateOfBirth, ...rest } = prevErrors;
                                return rest;
                            });
                        } else {
                            newState.dateOfBirth = '';
                        }
                    }
                    return newState;
                });
                addLog('fieldInput', { fieldName: name });
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                addLog('navigationAttempt', { action: 'submit' });
                
                if (validateForm()) {
                    const endTime = performance.now();
                    const completionTime = ((endTime - (firstInteraction || endTime)) / 1000).toFixed(2);
                    const totalErrors = logs.filter(l => l.event === 'validationError').length;
                    
                    addLog('formSubmit', { timestamp: endTime, completionTime });
                    
                    // ave completion status to localStorage
                    const storedData = JSON.parse(localStorage.getItem('formStudyData') || '{}');
                    localStorage.setItem('formStudyData', JSON.stringify({
                        ...storedData,
                        status: {
                            ...storedData.status,
                            'A': { status: 'complete', errors: totalErrors, time: completionTime }
                        }
                    }));
                    
                    // Check if NASA-TLX already completed for Variant A
                    const tlxData = JSON.parse(localStorage.getItem('nasa_tlx_A') || '{}');
                    const tlxCompleted = tlxData[participantId.current] !== undefined;
                    
                    if (tlxCompleted) {
                        // NASA-TLX already done, go to index
                        window.location.href = 'index.html';
                    } else {
                        // Redirect to NASA-TLX
                        window.location.href = `NASATLX.html?variant=A&participant=${participantId.current}`;
                    }
                } else {
                    addLog('navigationBlock', { action: 'submit', reason: 'validation_errors', errorCount: Object.keys(errors).length });
                    if (errorModalRef.current) {
                        errorModalRef.current.style.display = 'flex';
                        setTimeout(() => {
                             errorModalRef.current.style.display = 'none';
                        }, 3000);
                    }
                }
            };

            const downloadLogs = () => {
                if (logs.length === 0) return;
                
                const headers = Object.keys(logs[0] || {}).join(',');
                const rows = logs.map(row => Object.values(row).map(val => {
                    let stringVal = String(val);
                    if (stringVal.includes(',') || stringVal.includes('"') || stringVal.includes('\n')) {
                        return `"${stringVal.replace(/"/g, '""')}"`;
                    }
                    return stringVal;
                }).join(','));
                
                const csv = [headers, ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${participantId.current}_VariantA_logs.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            };
            
            const renderField = (fieldConfig) => {
                const { name, label, type, required, colSpan = 1 } = fieldConfig;
                const hasError = errors[name];
                const colClass = colSpan === 2 ? 'md:col-span-2' : '';

                if (type === 'textarea') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <textarea
                                name={name}
                                value={formData[name]}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                rows="4"
                                className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                placeholder={`Enter your ${label.toLowerCase()} here...`}
                            />
                        </div>
                    );
                }

                if (type === 'select') {
                    const options = name === 'employmentStatus' ? 
                        ['Select...', 'Employed', 'Unemployed', 'Student', 'Self-Employed'] : [];
                    if (name === 'desiredPosition') {
                        options.push('Select...', 'Software Engineer', 'Product Manager', 'Designer', 'Data Analyst', 'Other');
                    } else if (options.length === 0) {
                        options.push('Select...');
                    }   
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <select
                                name={name}
                                value={formData[name]}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                onBlur={(e) => handleBlur(name, e.target.value)}
                                className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                            >
                                {options.map(opt => <option key={opt} value={opt === 'Select...' ? '' : opt.toLowerCase()}>{opt}</option>)}
                            </select>
                            {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                        </div>
                    );
                }

                if (type === 'year-select') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <select
                                name={name}
                                value={formData[name]}
                                onChange={handleChange}
                                onFocus={() => handleFocus(name)}
                                onBlur={(e) => handleBlur(name, e.target.value)}
                                className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                            >
                                <option value="">Select Year</option>
                                {Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i).map(year => (
                                    <option key={year} value={year}>{year}</option>
                                ))}
                            </select>
                            {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                        </div>
                    );
                }
                
                if (type === 'date-composite') {
                    return (
                        <div key={name} className={colClass}>
                            <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                            <div className="grid grid-cols-3 gap-2">
                                <select 
                                    name="dobYear" 
                                    value={formData.dobYear} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobYear')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Year</option>
                                    {Array.from({ length: 100 }, (_, i) => new Date().getFullYear() - i).map(year => <option key={year} value={year}>{year}</option>)}
                                </select>
                                <select 
                                    name="dobMonth" 
                                    value={formData.dobMonth} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobMonth')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Month</option>
                                    {Array.from({ length: 12 }, (_, i) => String(i + 1).padStart(2, '0')).map(month => <option key={month} value={month}>{new Date(0, month-1).toLocaleString('default', { month: 'short' })}</option>)}
                                </select>
                                <select 
                                    name="dobDay" 
                                    value={formData.dobDay} 
                                    onChange={handleChange} 
                                    onFocus={() => handleFocus('dobDay')} 
                                    className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${errors.dateOfBirth ? 'border-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                                >
                                    <option value="">Day</option>
                                    {Array.from({ length: 31 }, (_, i) => String(i + 1).padStart(2, '0')).map(day => <option key={day} value={day}>{day}</option>)}
                                </select>
                            </div>
                            {errors.dateOfBirth && <p className="text-red-500 text-xs mt-1">{errors.dateOfBirth}</p>}
                        </div>
                    );
                }

                return (
                    <div key={name} className={colClass}>
                        <label className="block text-sm font-medium text-gray-700 mb-1">{label} {required && '*'}</label>
                        <input
                            type={type}
                            name={name}
                            value={formData[name]}
                            onChange={handleChange}
                            onFocus={() => handleFocus(name)}
                            onBlur={(e) => handleBlur(name, e.target.value)}
                            className={`w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 ${hasError ? 'border-red-500 focus:ring-red-500' : 'border-gray-300 focus:ring-indigo-500'}`}
                            required={required}
                        />
                        {hasError && <p className="text-red-500 text-xs mt-1">{hasError}</p>}
                    </div>
                );
            };

            const renderAllFields = () => {
                const groupedFields = ALL_FIELDS.reduce((acc, field) => {
                    const group = field.group;
                    if (!acc[group]) {
                        acc[group] = [];
                    }
                    acc[group].push(field);
                    return acc;
                }, {});

                return Object.keys(groupedFields).map(groupName => (
                    <div key={groupName} className="mb-8 border p-6 rounded-lg bg-gray-50/70 shadow-inner">
                        <h3 className="text-xl font-bold text-indigo-700 mb-4 pb-2 border-b-2 border-indigo-300">{groupName}</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {groupedFields[groupName].map(renderField)}
                        </div>
                    </div>
                ));
            };

            if (submitted) {
                const completionTimeSeconds = ((performance.now() - (firstInteraction || performance.now())) / 1000).toFixed(2);
                const totalErrors = logs.filter(l => l.event === 'validationError').length;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-8 flex items-center justify-center">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full text-center border-t-8 border-indigo-600">
                            <div className="text-indigo-600 text-7xl mb-4">
                                <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <h2 className="text-3xl font-extrabold text-gray-900 mb-4">Application Submitted!</h2>
                            <p className="text-gray-600 mb-6">Thank you for completing the application form. We will be in touch shortly.</p>
                            <button onClick={downloadLogs} className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2 mx-auto shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                                <Download size={20} />
                                Download Session Logs
                            </button>
                            <div className="mt-8 text-sm text-gray-500 bg-gray-50 p-4 rounded-lg">
                                <p>Total Events Logged: <span className="font-medium text-gray-700">{logs.length}</span></p>
                                <p>Time to Complete (from first interaction): <span className="font-medium text-gray-700">{completionTimeSeconds}s</span></p>
                                <p>Total Validation Errors Triggered: <span className="font-medium text-gray-700">{totalErrors}</span></p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4 sm:p-8 font-sans">
                    <div ref={errorModalRef} style={{ display: 'none' }} className="fixed top-4 right-4 z-50 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-xl animate-fade-in-down transition duration-500 ease-in-out hidden items-center space-x-2" role="alert">
                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd"></path></svg>
                        <p className="font-medium text-sm">Please correct the highlighted error(s) to submit the form.</p>
                    </div>

                    <form onSubmit={handleSubmit} className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-10">
                        <div className="mb-8">
                            <h1 className="text-3xl font-extrabold text-gray-900 mb-2">Job Application Form</h1>
                            <p className="text-gray-600">Variant A: Single-Page Form</p>
                            <p className="text-sm text-gray-500 mt-1">Participant ID: {participantId.current}</p>
                        </div>
                        
                        <div className="space-y-6">
                            {renderAllFields()}
                        </div>

                        <div className="flex justify-between pt-8 border-t mt-8">
                            <button 
                                type="button"
                                onClick={() => window.location.href = 'index.html'}
                                className="bg-gray-400 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-500 transition shadow-md"
                            >
                                Back to Index
                            </button>
                            <button 
                                type="submit"
                                className="bg-indigo-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md"
                            >
                                Submit Application
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SinglePageForm />);
    </script>
</body>
</html>